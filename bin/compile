#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>
#
# shellcheck disable=SC1090

# fail fast
set -e

# Get the absolute path of the builpack directory
BP_DIR="$(cd "${0%/*}/.."; pwd)"
BIN_DIR="${BP_DIR}/bin"

# parse args
BUILD_DIR="$1"
CACHE_DIR="$2"
ENV_DIR="$3"

# Load WildFly utilites from Heroku WildFly buildpack
HEROKU_WILDFLY_BUILDPACK_DIR="/tmp/heroku-buildpack-wildfly"
git clone --quiet https://github.com/mortenterhart/heroku-buildpack-wildfly.git "${HEROKU_WILDFLY_BUILDPACK_DIR}"
source "${HEROKU_WILDFLY_BUILDPACK_DIR}/lib/wildfly_utils.sh"

source "${BP_DIR}/lib/datasource_utils.sh"
source "${BP_DIR}/lib/environment.sh"

export_env_dir "${ENV_DIR}"

install_postgresql_driver "${BUILD_DIR}" "${CACHE_DIR}"
install_postgresql_datasource "${BUILD_DIR}"
