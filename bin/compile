#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>
#
# shellcheck disable=SC1090

# fail fast
set -e

# Get the absolute path of the builpack directory
BP_DIR="$(cd "${0%/*}/.."; pwd)"

# parse args
BUILD_DIR="$1"
CACHE_DIR="$2"
ENV_DIR="$3"

# Load JVM Common buildpack utilities
JVM_COMMON_BUILDPACK_URL="${JVM_COMMON_BUILDPACK_URL:-"https://buildpack-registry.s3.amazonaws.com/buildpacks/heroku/jvm.tgz"}"
JVM_COMMON_DIR="/tmp/jvm-common"
mkdir -p "${JVM_COMMON_DIR}"
curl --retry 3 --silent --location "${JVM_COMMON_BUILDPACK_URL}" | tar xzm -C "${JVM_COMMON_DIR}" --strip-components=1
source "${JVM_COMMON_DIR}/bin/util"

# Load all scripts from lib/ directory
# Temporary solution (TODO: Add some kind of dependency management between the scripts)
for script in "${BP_DIR}"/lib/*.sh; do
    source "${script}"
done
unset script

export_env_dir "${ENV_DIR}"

install_postgresql_driver "${BUILD_DIR}" "${CACHE_DIR}"
install_postgresql_datasource "${BUILD_DIR}"
